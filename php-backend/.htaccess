# ==================================================
# RFID-MQTT PHP Backend - Apache Configuration
# ==================================================
# Performance optimizations for API endpoints
# Compatible with Apache 2.4+
# ==================================================

# ==================== COMPRESSION ====================

<IfModule mod_deflate.c>
    # Enable compression for text-based files
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/atom+xml
    AddOutputFilterByType DEFLATE image/svg+xml
    
    # Set compression level (1-9, 9 = maximum compression)
    DeflateCompressionLevel 6
    
    # Don't compress already-compressed files
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|rar|bz2|7z)$ no-gzip
    
    # Handle proxied requests
    Header append Vary: Accept-Encoding
    
    # Log compression ratio (optional, disable in production)
    # DeflateFilterNote Input instream
    # DeflateFilterNote Output outstream
    # DeflateFilterNote Ratio ratio
    # LogFormat '"%r" %{outstream}n/%{instream}n (%{ratio}n%%)' deflate
</IfModule>

# Fallback for servers without mod_deflate (use mod_gzip)
<IfModule !mod_deflate.c>
    <IfModule mod_gzip.c>
        mod_gzip_on Yes
        mod_gzip_dechunk Yes
        mod_gzip_item_include file \.(html?|txt|css|js|php|json)$
        mod_gzip_item_include mime ^text/.*
        mod_gzip_item_include mime ^application/javascript
        mod_gzip_item_include mime ^application/json
        mod_gzip_item_exclude mime ^image/.*
        mod_gzip_item_exclude mime ^video/.*
        mod_gzip_item_exclude mime ^audio/.*
    </IfModule>
</IfModule>

# ==================== CORS HEADERS ====================

<IfModule mod_headers.c>
    # Allow all origins (development only - restrict in production)
    # Use 'set' instead of 'always set' to avoid duplicates
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header set Access-Control-Max-Age "3600"
</IfModule>


# ==================== CACHING HEADERS ====================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # API responses - short cache (2 seconds for frequently changing data)
    <FilesMatch "\.(php)$">
        Header set Cache-Control "public, max-age=2, must-revalidate"
    </FilesMatch>
    
    # Static files (if any)
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType text/javascript "access plus 1 week"
</IfModule>

# ==================== SECURITY ====================

<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevent clickjacking (adjust for your needs)
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Remove sensitive headers
    Header unset X-Powered-By
    Header unset Server
</IfModule>

# Hide PHP version
ServerSignature Off

# Disable directory browsing
Options -Indexes

# Prevent access to sensitive files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<Files "*.ini">
    Require all denied
</Files>

<Files "*.md">
    Require all denied
</Files>

# ==================== PHP SETTINGS ====================

<IfModule mod_php7.c>
    # Increase memory limit for API requests
    php_value memory_limit 256M
    
    # Set max execution time
    php_value max_execution_time 30
    
    # Set timezone
    php_value date.timezone "Asia/Manila"
    
    # Disable unnecessary functions (optional security hardening)
    # php_value disable_functions "exec,passthru,shell_exec,system"
</IfModule>

<IfModule mod_php8.c>
    php_value memory_limit 256M
    php_value max_execution_time 30
    php_value date.timezone "Asia/Manila"
</IfModule>

# ==================== URL REWRITING ====================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /php-backend/
    
    # Handle preflight OPTIONS requests for CORS
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ $1 [R=204,L]
    
    # Force trailing slash on directories
    # RewriteCond %{REQUEST_FILENAME} -d
    # RewriteCond %{REQUEST_URI} !(.*)/$
    # RewriteRule ^(.*)$ $1/ [L,R=301]
    
    # Remove .php extension (optional, uncomment if desired)
    # RewriteCond %{REQUEST_FILENAME} !-d
    # RewriteCond %{REQUEST_FILENAME}\.php -f
    # RewriteRule ^(.*)$ $1.php [L]
</IfModule>

# ==================== ERROR HANDLING ====================

# Custom error pages (optional)
# ErrorDocument 404 /php-backend/errors/404.php
# ErrorDocument 500 /php-backend/errors/500.php

# Show errors in development, hide in production
# Development: php_flag display_errors On
# Production: php_flag display_errors Off

# ==================== PERFORMANCE TUNING ====================

<IfModule mod_headers.c>
    # Enable Keep-Alive
    Header set Connection keep-alive
</IfModule>

# Set ETags for better caching
FileETag MTime Size

# ==================== NOTES ====================

# Compression Benefits:
# - JSON responses: 70-85% size reduction
# - Typical API response: 2-5 KB â†’ 0.5-1 KB
# - Reduces bandwidth usage
# - Faster response times over network
#
# To verify compression is working:
# 1. Visit http://localhost/php-backend/api/get_logs.php
# 2. Check response headers for "Content-Encoding: gzip"
# 3. Compare Content-Length with uncompressed size
#
# To disable compression (for debugging):
# 1. Rename this file to .htaccess.disabled
# 2. Restart Apache
#
# Performance Impact:
# - API responses: 60-80% faster transfer
# - CPU overhead: +2-5% (negligible)
# - Memory usage: +1-2 MB per request
# - Overall: Highly recommended for production

# ==================== END OF CONFIGURATION ====================
